<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OIKOS ¬∑ GitHub Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cabinet+Grotesk:wght@700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:       #060709;
  --s1:       #0d0f14;
  --s2:       #12151c;
  --border:   #1c2030;
  --border2:  #262d40;
  --g:        #00ffaa;
  --g2:       #00c97d;
  --gdim:     rgba(0,255,170,0.08);
  --gdim2:    rgba(0,255,170,0.15);
  --blue:     #4d9fff;
  --bdim:     rgba(77,159,255,0.1);
  --amber:    #ffb84d;
  --adim:     rgba(255,184,77,0.1);
  --red:      #ff5c5c;
  --rdim:     rgba(255,92,92,0.1);
  --purple:   #c084fc;
  --pdim:     rgba(192,132,252,0.1);
  --text:     #e8edf5;
  --muted:    #4a5568;
  --muted2:   #6b7a94;
  --mono:     'JetBrains Mono', monospace;
  --head:     'Cabinet Grotesk', sans-serif;
}

* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior: smooth; }

body {
  font-family: var(--mono);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ Animated grid bg ‚îÄ‚îÄ */
.grid-bg {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image:
    linear-gradient(rgba(0,255,170,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,170,0.025) 1px, transparent 1px);
  background-size: 50px 50px;
  mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 40%, transparent 100%);
}

/* ‚îÄ‚îÄ Top glow ‚îÄ‚îÄ */
.top-glow {
  position: fixed; top: -300px; left: 50%; transform: translateX(-50%);
  width: 900px; height: 600px; z-index: 0; pointer-events: none;
  background: radial-gradient(ellipse, rgba(0,255,170,0.07) 0%, transparent 65%);
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar {
  position: fixed; left: 0; top: 0; bottom: 0;
  width: 72px;
  background: var(--s1);
  border-right: 1px solid var(--border);
  z-index: 100;
  display: flex; flex-direction: column; align-items: center;
  padding: 24px 0; gap: 8px;
}
.side-logo {
  width: 40px; height: 40px; border-radius: 10px;
  background: linear-gradient(135deg, var(--g), var(--g2));
  display: flex; align-items: center; justify-content: center;
  font-family: var(--head); font-weight: 900; font-size: 14px; color: #000;
  margin-bottom: 24px; flex-shrink: 0;
}
.side-btn {
  width: 44px; height: 44px; border-radius: 10px;
  background: transparent; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: var(--muted); transition: all 0.2s;
  position: relative;
}
.side-btn:hover, .side-btn.active { background: var(--gdim); color: var(--g); }
.side-btn svg { width: 20px; height: 20px; fill: currentColor; }
.side-sep { width: 32px; height: 1px; background: var(--border); margin: 8px 0; }

/* ‚îÄ‚îÄ MAIN WRAPPER ‚îÄ‚îÄ */
#app {
  margin-left: 72px;
  position: relative; z-index: 10;
  min-height: 100vh;
}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
#topbar {
  position: sticky; top: 0; z-index: 50;
  height: 64px;
  background: rgba(6,7,9,0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 32px; gap: 16px;
}
.topbar-title { font-family: var(--head); font-size: 22px; font-weight: 900; color: #fff; flex:1; }
.topbar-title span { color: var(--g); }
.live-pill {
  display: flex; align-items: center; gap: 6px;
  background: var(--gdim); border: 1px solid rgba(0,255,170,0.3);
  padding: 5px 12px; border-radius: 20px;
  font-size: 10px; font-weight: 600; letter-spacing: 1.5px; color: var(--g);
}
.live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--g); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(0,255,170,0.4)} 50%{box-shadow:0 0 0 6px rgba(0,255,170,0)} }

#btn-refresh {
  display: flex; align-items: center; gap: 7px;
  padding: 8px 16px; border-radius: 8px;
  background: transparent; border: 1px solid var(--border2);
  color: var(--muted2); font-family: var(--mono); font-size: 11px; font-weight: 600;
  cursor: pointer; letter-spacing: 0.5px;
  transition: all 0.2s;
}
#btn-refresh:hover { border-color: var(--g); color: var(--g); background: var(--gdim); }
#btn-refresh svg { width: 13px; height: 13px; fill: currentColor; }
#btn-refresh.spinning svg { animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ PAGE CONTENT ‚îÄ‚îÄ */
#content { padding: 28px 32px; }

/* ‚îÄ‚îÄ KPI ROW ‚îÄ‚îÄ */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}
.kpi-card {
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 18px 20px;
  display: flex; flex-direction: column; gap: 8px;
  position: relative; overflow: hidden;
  opacity: 0; animation: fadeUp 0.5s forwards;
  transition: border-color 0.2s, transform 0.2s;
}
.kpi-card:hover { border-color: var(--border2); transform: translateY(-2px); }
.kpi-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: var(--accent, var(--g));
}
.kpi-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted2); }
.kpi-val { font-family: var(--head); font-size: 32px; font-weight: 900; color: #fff; line-height: 1; }
.kpi-val.g { color: var(--g); }
.kpi-val.b { color: var(--blue); }
.kpi-val.a { color: var(--amber); }
.kpi-val.r { color: var(--red); }
.kpi-val.p { color: var(--purple); }
.kpi-sub { font-size: 10px; color: var(--muted); }
@keyframes fadeUp { to { opacity:1; transform:translateY(0); } }

/* ‚îÄ‚îÄ CHARTS ROW ‚îÄ‚îÄ */
.charts-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
}
.chart-card {
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 22px;
  opacity: 0; animation: fadeUp 0.5s forwards;
}
.chart-card.wide {
  grid-column: span 2;
}
.chart-title {
  font-size: 11px; letter-spacing: 2px; text-transform: uppercase;
  color: var(--muted2); margin-bottom: 18px;
  display: flex; align-items: center; gap: 8px;
}
.chart-title::before {
  content: ''; width: 3px; height: 14px; border-radius: 2px;
  background: var(--accent, var(--g));
}
.chart-wrap { position: relative; }

/* ‚îÄ‚îÄ REPOS SECTION ‚îÄ‚îÄ */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.section-label {
  font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: var(--muted2);
  display: flex; align-items: center; gap: 10px;
}
.section-label::after { content:''; width:40px; height:1px; background:var(--border2); }
.repo-count-badge {
  padding: 3px 10px; border-radius: 20px;
  background: var(--gdim); border: 1px solid rgba(0,255,170,0.2);
  color: var(--g); font-size: 10px; font-weight: 600;
}

/* ‚îÄ‚îÄ REPO CARDS ‚îÄ‚îÄ */
#cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  gap: 14px;
}

.repo-card {
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  opacity: 0; transform: translateY(12px);
  animation: fadeUp 0.45s forwards;
  transition: border-color 0.25s, box-shadow 0.25s, transform 0.25s;
}
.repo-card:hover {
  border-color: var(--border2);
  box-shadow: 0 0 0 1px var(--border2), 0 12px 40px rgba(0,0,0,0.5);
  transform: translateY(-4px);
}

/* Card accent strip */
.card-accent { height: 3px; width: 100%; }

.card-body { padding: 18px 20px; display: flex; flex-direction: column; gap: 14px; }

/* Card header */
.card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
.card-title-wrap { flex: 1; min-width: 0; }
.card-name {
  font-family: var(--head); font-size: 16px; font-weight: 800; color: #fff;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-bottom: 4px;
}
.card-desc { font-size: 11px; color: var(--muted2); line-height: 1.5; }
.lang-chip {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 6px;
  font-size: 10px; font-weight: 600; letter-spacing: 0.5px;
  border: 1px solid; flex-shrink: 0; white-space: nowrap;
}
.lang-dot { width: 7px; height: 7px; border-radius: 50%; }

/* Stats bar */
.stats-bar {
  display: grid; grid-template-columns: repeat(4,1fr);
  border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden;
}
.stat-cell {
  padding: 10px 6px; display: flex; flex-direction: column;
  align-items: center; gap: 2px;
  border-right: 1px solid var(--border);
  transition: background 0.2s;
}
.stat-cell:last-child { border-right: none; }
.stat-cell:hover { background: rgba(255,255,255,0.03); }
.stat-ico { font-size: 12px; }
.stat-v { font-size: 14px; font-weight: 700; color: #fff; font-family: var(--head); }
.stat-l { font-size: 8px; letter-spacing: 1px; color: var(--muted); text-transform: uppercase; }

/* Issues strip */
.issues-strip { display: flex; gap: 8px; }
.iss-pill {
  flex: 1; padding: 8px 12px; border-radius: 8px;
  display: flex; align-items: center; justify-content: space-between; gap: 8px;
  font-size: 10px; font-weight: 600;
}
.iss-pill.open  { background: var(--gdim); color: var(--g); border: 1px solid rgba(0,255,170,0.2); }
.iss-pill.other { background: var(--bdim); color: var(--blue); border: 1px solid rgba(77,159,255,0.2); }
.iss-num { font-family: var(--head); font-size: 20px; font-weight: 900; }

/* Mini commit log */
.commit-log { display: flex; flex-direction: column; gap: 5px; }
.commit-row {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 10px; border-radius: 7px;
  background: rgba(255,255,255,0.02);
  border-left: 2px solid var(--border2);
  transition: border-color 0.2s, background 0.2s;
}
.commit-row:hover { border-left-color: var(--g); background: var(--gdim); }
.c-hash { font-size: 10px; color: var(--g); font-weight: 600; flex-shrink: 0; min-width: 52px; }
.c-msg  { font-size: 10px; color: var(--muted2); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.c-time { font-size: 9px; color: var(--muted); flex-shrink: 0; }

/* Card footer */
.card-foot {
  display: flex; align-items: center; justify-content: space-between;
  padding-top: 12px; border-top: 1px solid var(--border);
  font-size: 10px; color: var(--muted);
}
.push-ind { display: flex; align-items: center; gap: 6px; }
.pdot { width: 7px; height: 7px; border-radius: 50%; }
.pdot.fresh  { background: var(--g);     box-shadow: 0 0 8px var(--g); }
.pdot.warm   { background: var(--amber); }
.pdot.cold   { background: var(--muted); }
.gh-link {
  display: flex; align-items: center; gap: 4px;
  color: var(--blue); text-decoration: none; font-weight: 600;
  font-size: 10px; transition: color 0.2s;
}
.gh-link:hover { color: #93c5fd; }

/* ‚îÄ‚îÄ LOADING / ERROR ‚îÄ‚îÄ */
#loading-screen {
  position: fixed; inset: 0; z-index: 200;
  background: var(--bg);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 24px;
}
.loader-logo {
  font-family: var(--head); font-size: 48px; font-weight: 900; color: #fff;
  opacity: 0; animation: fadeUp 0.5s 0.2s forwards;
}
.loader-logo span { color: var(--g); }
.loader-bar-wrap {
  width: 240px; height: 2px; background: var(--border);
  border-radius: 2px; overflow: hidden;
  opacity: 0; animation: fadeUp 0.5s 0.4s forwards;
}
.loader-bar {
  height: 100%; background: linear-gradient(90deg, var(--g2), var(--g));
  border-radius: 2px;
  animation: loadprogress 2s ease forwards;
}
@keyframes loadprogress { 0%{width:0} 60%{width:80%} 100%{width:100%} }
.loader-status {
  font-size: 11px; color: var(--muted2); letter-spacing: 1px;
  opacity: 0; animation: fadeUp 0.5s 0.6s forwards;
}
#error-toast {
  display: none;
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--rdim); border: 1px solid var(--red);
  color: var(--red); padding: 12px 24px; border-radius: 10px;
  font-size: 12px; z-index: 300;
}

/* Token modal */
#token-modal {
  display: none;
  position: fixed; inset: 0; z-index: 400;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
  align-items: center; justify-content: center;
}
#token-modal.open { display: flex; }
.modal-box {
  background: var(--s2); border: 1px solid var(--border2);
  border-radius: 20px; padding: 32px; width: 480px; max-width: 90vw;
}
.modal-title { font-family: var(--head); font-size: 22px; font-weight: 800; color: #fff; margin-bottom: 8px; }
.modal-sub { font-size: 12px; color: var(--muted2); margin-bottom: 20px; line-height: 1.6; }
.modal-input {
  width: 100%; padding: 12px 16px;
  background: var(--s1); border: 1px solid var(--border2);
  border-radius: 10px; color: #fff;
  font-family: var(--mono); font-size: 13px; outline: none;
  margin-bottom: 12px;
  transition: border-color 0.2s;
}
.modal-input:focus { border-color: var(--g); }
.modal-btns { display: flex; gap: 8px; }
.modal-btn {
  flex: 1; padding: 11px; border-radius: 10px;
  font-family: var(--mono); font-size: 12px; font-weight: 700;
  cursor: pointer; border: none; transition: all 0.2s;
}
.modal-btn.primary { background: var(--g); color: #000; }
.modal-btn.primary:hover { background: var(--g2); }
.modal-btn.secondary { background: var(--border); color: var(--muted2); }
.modal-btn.secondary:hover { background: var(--border2); color: var(--text); }

@media(max-width: 1100px) { .kpi-row { grid-template-columns: repeat(3,1fr); } }
@media(max-width: 900px)  { .charts-row { grid-template-columns: 1fr; } .chart-card.wide { grid-column: span 1; } }
@media(max-width: 700px)  { #sidebar { display: none; } #app { margin-left: 0; } #content { padding: 16px; } .kpi-row { grid-template-columns: repeat(2,1fr); } }
</style>
</head>
<body>

<!-- BG -->
<div class="grid-bg"></div>
<div class="top-glow"></div>

<!-- LOADING -->
<div id="loading-screen">
  <div class="loader-logo">OIKOS <span>Dev</span></div>
  <div class="loader-bar-wrap"><div class="loader-bar"></div></div>
  <div class="loader-status" id="load-status">Conectando con GitHub API...</div>
</div>

<!-- ERROR TOAST -->
<div id="error-toast"></div>

<!-- TOKEN MODAL -->
<div id="token-modal">
  <div class="modal-box">
    <div class="modal-title">üîë GitHub Token</div>
    <div class="modal-sub">Agrega tu Personal Access Token para ver repos privados y eliminar el rate limit de 60 req/hora. El token se guarda solo en tu browser.</div>
    <input class="modal-input" type="password" id="gh-token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
    <div class="modal-btns">
      <button class="modal-btn primary" onclick="applyToken()">APLICAR TOKEN</button>
      <button class="modal-btn secondary" onclick="closeTokenModal()">CANCELAR</button>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="side-logo">OK</div>
  <button class="side-btn active" title="Dashboard">
    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
  </button>
  <div class="side-sep"></div>
  <button class="side-btn" title="GitHub Token" onclick="openTokenModal()">
    <svg viewBox="0 0 24 24"><path d="M12 1C5.925 1 1 5.925 1 12c0 4.86 3.152 8.983 7.523 10.437.55.101.75-.238.75-.53 0-.262-.01-1.133-.015-2.066C6.726 20.4 6.112 18.434 6.112 18.434c-.5-1.271-1.221-1.61-1.221-1.61-.999-.682.076-.668.076-.668 1.105.078 1.685 1.134 1.685 1.134.981 1.682 2.575 1.195 3.202.914.1-.71.384-1.195.698-1.47-2.441-.278-5.007-1.222-5.007-5.438 0-1.2.428-2.182 1.132-2.952-.114-.278-.491-1.396.108-2.91 0 0 .923-.295 3.025 1.128A10.536 10.536 0 0 1 12 6.31c.935.004 1.877.127 2.754.372 2.1-1.423 3.023-1.128 3.023-1.128.6 1.514.223 2.632.11 2.91.704.77 1.13 1.752 1.13 2.952 0 4.227-2.57 5.157-5.018 5.43.394.34.746 1.01.746 2.034 0 1.47-.014 2.657-.014 3.018 0 .294.198.636.756.528C19.851 20.979 23 16.859 23 12c0-6.075-4.925-11-11-11z"/></svg>
  </button>
  <button class="side-btn" title="Refrescar" onclick="refreshAll()">
    <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
  </button>
</div>

<!-- APP -->
<div id="app">
  <!-- TOPBAR -->
  <div id="topbar">
    <div class="topbar-title">OIKOS <span>Dev Intelligence</span></div>
    <div class="live-pill"><div class="live-dot"></div>LIVE</div>
    <div id="last-update" style="font-size:10px;color:var(--muted);"></div>
    <button id="btn-refresh" onclick="refreshAll()">
      <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
      REFRESH
    </button>
  </div>

  <!-- CONTENT -->
  <div id="content" style="display:none;">

    <!-- KPIs -->
    <div class="kpi-row" id="kpi-row">
      <div class="kpi-card" style="--accent:var(--g);animation-delay:0.05s">
        <div class="kpi-label">Repositorios</div>
        <div class="kpi-val g" id="k-repos">0</div>
        <div class="kpi-sub">p√∫blicos activos</div>
      </div>
      <div class="kpi-card" style="--accent:var(--blue);animation-delay:0.1s">
        <div class="kpi-label">Total Stars</div>
        <div class="kpi-val b" id="k-stars">0</div>
        <div class="kpi-sub">acumuladas</div>
      </div>
      <div class="kpi-card" style="--accent:var(--amber);animation-delay:0.15s">
        <div class="kpi-label">Forks</div>
        <div class="kpi-val a" id="k-forks">0</div>
        <div class="kpi-sub">total</div>
      </div>
      <div class="kpi-card" style="--accent:var(--red);animation-delay:0.2s">
        <div class="kpi-label">Issues Abiertos</div>
        <div class="kpi-val r" id="k-issues">0</div>
        <div class="kpi-sub">pendientes</div>
      </div>
      <div class="kpi-card" style="--accent:var(--purple);animation-delay:0.25s">
        <div class="kpi-label">Lenguajes</div>
        <div class="kpi-val p" id="k-langs">0</div>
        <div class="kpi-sub">distintos</div>
      </div>
      <div class="kpi-card" style="--accent:var(--g);animation-delay:0.3s">
        <div class="kpi-label">√öltimo Push</div>
        <div class="kpi-val g" id="k-lastpush" style="font-size:18px;padding-top:6px;">‚Äî</div>
        <div class="kpi-sub" id="k-lastpush-repo">‚Äî</div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="charts-row">
      <!-- Commits por repo (barra) -->
      <div class="chart-card wide" style="--accent:var(--g);animation-delay:0.35s">
        <div class="chart-title">Actividad de Commits por Repositorio</div>
        <div class="chart-wrap" style="height:220px;">
          <canvas id="chart-commits"></canvas>
        </div>
      </div>

      <!-- Lenguajes (dona) -->
      <div class="chart-card" style="--accent:var(--purple);animation-delay:0.4s">
        <div class="chart-title" style="--accent:var(--purple)">Lenguajes</div>
        <div class="chart-wrap" style="height:220px;display:flex;align-items:center;justify-content:center;">
          <canvas id="chart-langs" style="max-width:200px;max-height:200px;"></canvas>
        </div>
      </div>
    </div>

    <!-- STARS ranking -->
    <div class="charts-row" style="grid-template-columns:1fr 1fr;margin-bottom:24px;">
      <div class="chart-card" style="--accent:var(--blue);animation-delay:0.45s">
        <div class="chart-title" style="--accent:var(--blue)">Stars por Repositorio</div>
        <div class="chart-wrap" style="height:200px;">
          <canvas id="chart-stars"></canvas>
        </div>
      </div>
      <div class="chart-card" style="--accent:var(--amber);animation-delay:0.5s">
        <div class="chart-title" style="--accent:var(--amber)">Issues Abiertos por Repo</div>
        <div class="chart-wrap" style="height:200px;">
          <canvas id="chart-issues"></canvas>
        </div>
      </div>
    </div>

    <!-- REPO CARDS -->
    <div class="section-header">
      <div class="section-label">Repositorios</div>
      <div class="repo-count-badge" id="repo-badge">0 repos</div>
    </div>
    <div id="cards-grid"></div>
  </div>
</div>

<script>
const ORG = 'analistadatos-Oikos';
let ghToken = localStorage.getItem('gh_token') || '';
let charts = {};

// ‚îÄ‚îÄ TOKEN MODAL ‚îÄ‚îÄ
function openTokenModal() {
  document.getElementById('gh-token-input').value = ghToken;
  document.getElementById('token-modal').classList.add('open');
}
function closeTokenModal() { document.getElementById('token-modal').classList.remove('open'); }
function applyToken() {
  ghToken = document.getElementById('gh-token-input').value.trim();
  if (ghToken) localStorage.setItem('gh_token', ghToken);
  else localStorage.removeItem('gh_token');
  closeTokenModal();
  refreshAll();
}

// ‚îÄ‚îÄ API ‚îÄ‚îÄ
function hdrs() {
  const h = { 'Accept': 'application/vnd.github+json' };
  if (ghToken) h['Authorization'] = `Bearer ${ghToken}`;
  return h;
}
async function get(url) {
  const r = await fetch(url, { headers: hdrs() });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function timeAgo(d) {
  if (!d) return '‚Äî';
  const s = (Date.now() - new Date(d)) / 1000;
  if (s < 60)    return 'ahora';
  if (s < 3600)  return `${Math.floor(s/60)}m`;
  if (s < 86400) return `${Math.floor(s/3600)}h`;
  if (s < 604800)return `${Math.floor(s/86400)}d`;
  return `${Math.floor(s/2592000)}mes`;
}
function pushCls(d) {
  const days = (Date.now() - new Date(d)) / 86400000;
  return days < 7 ? 'fresh' : days < 30 ? 'warm' : 'cold';
}

// ‚îÄ‚îÄ LANG PALETTE ‚îÄ‚îÄ
const LC = {
  JavaScript: { bg:'#2d1f05', bd:'#f59e0b', dot:'#f59e0b', tx:'#fbbf24', chart:'rgba(245,158,11,0.8)' },
  Python:     { bg:'#071830', bd:'#3b82f6', dot:'#3b82f6', tx:'#60a5fa', chart:'rgba(59,130,246,0.8)' },
  HTML:       { bg:'#1f0b02', bd:'#ea580c', dot:'#ea580c', tx:'#fb923c', chart:'rgba(234,88,12,0.8)'  },
  CSS:        { bg:'#0a0e2a', bd:'#6366f1', dot:'#6366f1', tx:'#818cf8', chart:'rgba(99,102,241,0.8)' },
  TypeScript: { bg:'#040e2a', bd:'#2563eb', dot:'#2563eb', tx:'#93c5fd', chart:'rgba(37,99,235,0.8)'  },
  Shell:      { bg:'#001509', bd:'#00ffaa', dot:'#00ffaa', tx:'#00ffaa', chart:'rgba(0,255,170,0.8)'  },
  Dockerfile: { bg:'#021525', bd:'#0ea5e9', dot:'#0ea5e9', tx:'#38bdf8', chart:'rgba(14,165,233,0.8)' },
  default:    { bg:'#111', bd:'#4a5568', dot:'#94a3b8', tx:'#94a3b8', chart:'rgba(148,163,184,0.8)'   },
};
function lc(lang) { return LC[lang] || LC.default; }

// ‚îÄ‚îÄ CHART DEFAULTS ‚îÄ‚îÄ
const CHART_DEFAULTS = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: { legend: { display: false } },
  scales: {
    x: { ticks: { color: '#4a5568', font: { family: "'JetBrains Mono'", size: 9 } }, grid: { color: '#1c2030' } },
    y: { ticks: { color: '#4a5568', font: { family: "'JetBrains Mono'", size: 9 } }, grid: { color: '#1c2030' } }
  }
};

function destroyCharts() {
  Object.values(charts).forEach(c => c.destroy());
  charts = {};
}

function buildCharts(repos, allCommits) {
  destroyCharts();

  // Sort by pushed for charts
  const top = [...repos].sort((a,b) => b.pushed_at > a.pushed_at ? 1 : -1).slice(0, 12);

  // ‚îÄ‚îÄ Commits bar chart ‚îÄ‚îÄ
  const commitCounts = top.map(r => (allCommits[r.name] || []).length);
  charts.commits = new Chart(document.getElementById('chart-commits'), {
    type: 'bar',
    data: {
      labels: top.map(r => r.name.replace('analistadatos-Oikos/', '').slice(0,18)),
      datasets: [{
        data: commitCounts,
        backgroundColor: top.map(r => lc(r.language).chart),
        borderColor: top.map(r => lc(r.language).bd),
        borderWidth: 1,
        borderRadius: 6,
      }]
    },
    options: { ...CHART_DEFAULTS, plugins: { legend: { display: false } } }
  });

  // ‚îÄ‚îÄ Lang donut ‚îÄ‚îÄ
  const langCount = {};
  repos.forEach(r => { if (r.language) langCount[r.language] = (langCount[r.language]||0) + 1; });
  const langKeys = Object.keys(langCount).sort((a,b) => langCount[b]-langCount[a]);
  charts.langs = new Chart(document.getElementById('chart-langs'), {
    type: 'doughnut',
    data: {
      labels: langKeys,
      datasets: [{
        data: langKeys.map(l => langCount[l]),
        backgroundColor: langKeys.map(l => lc(l).chart),
        borderColor: langKeys.map(l => lc(l).bd),
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true, position: 'bottom',
          labels: { color: '#6b7a94', font: { family: "'JetBrains Mono'", size: 9 }, boxWidth: 10, padding: 8 }
        }
      },
      cutout: '65%'
    }
  });

  // ‚îÄ‚îÄ Stars bar ‚îÄ‚îÄ
  const topStars = [...repos].sort((a,b) => b.stargazers_count - a.stargazers_count).slice(0,10);
  charts.stars = new Chart(document.getElementById('chart-stars'), {
    type: 'bar',
    data: {
      labels: topStars.map(r => r.name.slice(0,16)),
      datasets: [{
        data: topStars.map(r => r.stargazers_count),
        backgroundColor: 'rgba(77,159,255,0.7)',
        borderColor: '#4d9fff',
        borderWidth: 1, borderRadius: 5,
      }]
    },
    options: { ...CHART_DEFAULTS }
  });

  // ‚îÄ‚îÄ Issues bar ‚îÄ‚îÄ
  const topIssues = [...repos].filter(r => r.open_issues_count > 0)
    .sort((a,b) => b.open_issues_count - a.open_issues_count).slice(0,10);
  charts.issues = new Chart(document.getElementById('chart-issues'), {
    type: 'bar',
    data: {
      labels: topIssues.map(r => r.name.slice(0,16)),
      datasets: [{
        data: topIssues.map(r => r.open_issues_count),
        backgroundColor: 'rgba(255,92,92,0.7)',
        borderColor: '#ff5c5c',
        borderWidth: 1, borderRadius: 5,
      }]
    },
    options: { ...CHART_DEFAULTS }
  });
}

// ‚îÄ‚îÄ BUILD REPO CARD ‚îÄ‚îÄ
function buildCard(repo, commits, idx) {
  const s = lc(repo.language);
  const pc = pushCls(repo.pushed_at);
  const accentColor = pc === 'fresh' ? 'var(--g)' : pc === 'warm' ? 'var(--amber)' : 'var(--border2)';

  const langChip = repo.language
    ? `<span class="lang-chip" style="background:${s.bg};border-color:${s.bd};color:${s.tx}">
         <span class="lang-dot" style="background:${s.dot}"></span>${repo.language}
       </span>`
    : `<span class="lang-chip" style="background:#111;border-color:#333;color:#555">N/A</span>`;

  const commitRows = commits.length
    ? commits.slice(0,3).map(c => `
        <div class="commit-row">
          <span class="c-hash">${c.sha}</span>
          <span class="c-msg">${esc(c.message)}</span>
          <span class="c-time">${timeAgo(c.date)}</span>
        </div>`).join('')
    : `<div class="commit-row"><span class="c-msg" style="color:var(--muted)">Sin commits recientes</span></div>`;

  const size = repo.size > 1024 ? (repo.size/1024).toFixed(1)+'MB' : repo.size+'KB';

  return `
    <div class="repo-card" style="animation-delay:${0.04*idx}s">
      <div class="card-accent" style="background:linear-gradient(90deg,${accentColor},transparent)"></div>
      <div class="card-body">
        <div class="card-header">
          <div class="card-title-wrap">
            <div class="card-name" title="${esc(repo.name)}">${esc(repo.name)}</div>
            <div class="card-desc">${esc(repo.description || 'Sin descripci√≥n')}</div>
          </div>
          ${langChip}
        </div>

        <div class="stats-bar">
          <div class="stat-cell"><span class="stat-ico">‚≠ê</span><span class="stat-v">${repo.stargazers_count}</span><span class="stat-l">Stars</span></div>
          <div class="stat-cell"><span class="stat-ico">üç¥</span><span class="stat-v">${repo.forks_count}</span><span class="stat-l">Forks</span></div>
          <div class="stat-cell"><span class="stat-ico">üëÅ</span><span class="stat-v">${repo.watchers_count}</span><span class="stat-l">Watch</span></div>
          <div class="stat-cell"><span class="stat-ico">üì¶</span><span class="stat-v">${size}</span><span class="stat-l">Size</span></div>
        </div>

        <div class="issues-strip">
          <div class="iss-pill open">
            <span>Issues abiertos</span>
            <span class="iss-num">${repo.open_issues_count}</span>
          </div>
          <div class="iss-pill other">
            <span>Rama principal</span>
            <span style="font-weight:700;font-family:var(--mono);font-size:11px">${esc(repo.default_branch)}</span>
          </div>
        </div>

        <div class="commit-log">${commitRows}</div>

        <div class="card-foot">
          <div class="push-ind">
            <span class="pdot ${pc}"></span>
            Push ${timeAgo(repo.pushed_at)}
          </div>
          <a class="gh-link" href="${repo.html_url}" target="_blank" rel="noopener">
            GitHub
            <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><path d="M19 19H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
          </a>
        </div>
      </div>
    </div>`;
}

// ‚îÄ‚îÄ FETCH COMMITS ‚îÄ‚îÄ
async function fetchCommits(repoName) {
  try {
    const data = await get(`https://api.github.com/repos/${ORG}/${repoName}/commits?per_page=3`);
    return data.map(c => ({
      sha: c.sha.slice(0,7),
      message: c.commit.message.split('\n')[0].slice(0,60),
      date: c.commit.author.date
    }));
  } catch { return []; }
}

// ‚îÄ‚îÄ MAIN LOAD ‚îÄ‚îÄ
async function loadAll() {
  document.getElementById('content').style.display = 'none';
  document.getElementById('loading-screen').style.display = 'flex';
  document.getElementById('load-status').textContent = 'Conectando con GitHub API...';
  document.getElementById('btn-refresh').classList.add('spinning');

  try {
    // Fetch repos
    document.getElementById('load-status').textContent = 'Cargando repositorios...';
    let repos = [], page = 1;
    while (true) {
      const batch = await get(`https://api.github.com/orgs/${ORG}/repos?type=public&per_page=100&page=${page}&sort=pushed`);
      repos = repos.concat(batch);
      if (batch.length < 100) break;
      page++;
    }
    if (!repos.length) throw new Error('No se encontraron repos p√∫blicos en esta organizaci√≥n.');

    // KPIs
    const totalStars  = repos.reduce((a,r) => a + r.stargazers_count, 0);
    const totalForks  = repos.reduce((a,r) => a + r.forks_count, 0);
    const totalIssues = repos.reduce((a,r) => a + r.open_issues_count, 0);
    const langs = [...new Set(repos.map(r => r.language).filter(Boolean))];
    const sortedByPush = [...repos].sort((a,b) => new Date(b.pushed_at)-new Date(a.pushed_at));
    const lastPushRepo = sortedByPush[0];

    document.getElementById('k-repos').textContent    = repos.length;
    document.getElementById('k-stars').textContent    = totalStars;
    document.getElementById('k-forks').textContent    = totalForks;
    document.getElementById('k-issues').textContent   = totalIssues;
    document.getElementById('k-langs').textContent    = langs.length;
    document.getElementById('k-lastpush').textContent = timeAgo(lastPushRepo?.pushed_at);
    document.getElementById('k-lastpush-repo').textContent = lastPushRepo?.name || '‚Äî';
    document.getElementById('repo-badge').textContent = `${repos.length} repos`;
    document.getElementById('last-update').textContent = `Actualizado: ${new Date().toLocaleTimeString('es-CO')}`;

    // Commits ‚Äî chunked parallel
    document.getElementById('load-status').textContent = 'Cargando commits...';
    const CHUNK = 4;
    const allCommits = {};
    for (let i = 0; i < repos.length; i += CHUNK) {
      const chunk = repos.slice(i, i+CHUNK);
      const results = await Promise.all(chunk.map(r => fetchCommits(r.name)));
      chunk.forEach((r,j) => allCommits[r.name] = results[j]);
      document.getElementById('load-status').textContent =
        `Cargando commits... ${Math.min(i+CHUNK, repos.length)}/${repos.length}`;
    }

    // Charts
    buildCharts(repos, allCommits);

    // Cards
    const grid = document.getElementById('cards-grid');
    grid.innerHTML = '';
    sortedByPush.forEach((repo, idx) => {
      grid.insertAdjacentHTML('beforeend', buildCard(repo, allCommits[repo.name]||[], idx));
    });

    // Show
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('content').style.display = 'block';

  } catch(err) {
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('content').style.display = 'block';
    const toast = document.getElementById('error-toast');
    toast.textContent = err.message.includes('403')
      ? '‚ö† Rate limit de GitHub alcanzado. Abre el sidebar ‚Üí √≠cono üîë ‚Üí agrega tu token personal.'
      : `‚ö† Error: ${err.message}`;
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 8000);
  }

  document.getElementById('btn-refresh').classList.remove('spinning');
}

function refreshAll() { loadAll(); }

loadAll();
</script>
</body>
</html>
